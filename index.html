<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Urban Velocity - Street Racing Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Only what we really need -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',sans-serif;
      background:#000;
      color:#fff;
      overflow:hidden;
    }
    #gameContainer{
      position:relative;
      width:100vw;
      height:100vh;
      background:#000;
    }
    #gameCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      z-index:1;
    }

    /* HUD LAYER */
    #uiOverlay{
      position:absolute;
      inset:0;
      z-index:5;
      pointer-events:none;
    }
    .panel{
      pointer-events:auto;
      background:rgba(10,16,26,0.9);
      border-radius:12px;
      border:1px solid rgba(0,212,255,0.4);
      box-shadow:0 10px 30px rgba(0,0,0,0.7);
    }

    #speedometer{
      position:absolute;
      right:24px;
      bottom:24px;
      width:180px;
      height:180px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at 30% 10%,rgba(0,212,255,0.5) 0%,#020617 52%,#000 100%);
      border:2px solid #00d4ff;
    }
    .speed-value{
      font-family:'Orbitron',sans-serif;
      font-size:2.4rem;
      text-align:center;
      text-shadow:0 0 16px rgba(0,242,255,.9);
      color:#00f2ff;
    }
    .speed-unit{
      font-size:.75rem;
      letter-spacing:.16em;
      text-align:center;
      color:#9ca3af;
    }

    #minimap{
      position:absolute;
      right:24px;
      top:24px;
      width:200px;
      height:200px;
      overflow:hidden;
      border-radius:14px;
    }
    #minimap canvas{width:100%;height:100%;display:block}

    #scoreDisplay{
      position:absolute;
      left:24px;
      top:24px;
      padding:14px 18px;
      font-family:'Orbitron',sans-serif;
    }
    .score-item{display:flex;gap:8px;margin-bottom:6px;font-size:.9rem}
    .score-label{color:#9ca3af;font-size:.7rem;letter-spacing:.16em}
    .score-value{color:#00d4ff}

    #controlPanel{
      position:absolute;
      left:24px;
      bottom:24px;
      display:flex;
      gap:8px;
      padding:10px;
    }
    .hud-btn{
      pointer-events:auto;
      padding:8px 16px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,#00d4ff,#0099cc);
      color:#fff;
      font-size:.75rem;
      font-weight:600;
      letter-spacing:.14em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .hud-btn:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(0,212,255,.45)}
    .hud-btn:active{transform:translateY(0)}

    /* DAMAGE OVERLAY FROM resources/car_destruction.png */
    #damageOverlay{
      position:absolute;
      inset:0;
      z-index:6;
      pointer-events:none;
      background:
        radial-gradient(circle at center,rgba(0,0,0,.4),rgba(0,0,0,.9)),
        url("resources/car_destruction.png") center/contain no-repeat;
      opacity:0;
      transition:opacity .35s ease;
    }

    /* MAIN MENU (uses hero_racing.jpg) */
    #gameMenu{
      position:absolute;
      inset:0;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
    }
    #menuInner{
      width:min(900px,95vw);
      border-radius:24px;
      overflow:hidden;
      border:1px solid rgba(0,212,255,.45);
      box-shadow:0 25px 70px rgba(0,0,0,.9);
      position:relative;
    }
    #menuInner::before{
      content:"";
      position:absolute;
      inset:0;
      background:url("resources/hero_racing.jpg") center/cover no-repeat;
      filter:brightness(.65);
    }
    #menuInner::after{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top,rgba(15,23,42,.1),rgba(3,7,18,.9));
    }
    #menuContent{
      position:relative;
      padding:32px 32px 26px;
    }
    #menuTitle{
      font-family:'Orbitron',sans-serif;
      font-size:2.4rem;
      letter-spacing:.2em;
      text-transform:uppercase;
      color:#00f2ff;
      text-shadow:0 0 26px rgba(0,242,255,.9);
    }
    .menu-sub{
      margin-top:6px;
      letter-spacing:.16em;
      font-size:.8rem;
      text-transform:uppercase;
      color:#e5e7eb;
    }
    .menu-btn{
      margin-top:18px;
      display:block;
      width:100%;
      padding:12px 20px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,#ff6b35,#ff1f71);
      color:#fff;
      font-family:'Orbitron',sans-serif;
      font-size:.9rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .menu-btn+ .menu-btn{margin-top:10px}
    .menu-btn:hover{transform:translateY(-1px);box-shadow:0 15px 40px rgba(255,107,53,.5)}
    .menu-tip{
      margin-top:18px;
      font-size:.75rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:#9ca3af;
    }
    .hidden{display:none!important}

    /* LOADING */
    #loadingScreen{
      position:absolute;
      inset:0;
      z-index:20;
      background:#000;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    .loader{
      width:54px;
      height:54px;
      border-radius:50%;
      border:4px solid #00d4ff33;
      border-top-color:#00d4ff;
      animation:spin 1s linear infinite;
    }
    .loader-text{
      margin-top:14px;
      font-family:'Orbitron',sans-serif;
      font-size:.78rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#00d4ff;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    @media(max-width:768px){
      #speedometer{right:16px;bottom:16px;width:150px;height:150px}
      #minimap{right:16px;top:16px;width:170px;height:170px}
      #scoreDisplay{left:16px;top:16px}
      #controlPanel{left:16px;bottom:16px}
      #menuTitle{font-size:1.9rem}
    }
  </style>
</head>
<body>
<div id="gameContainer">
  <canvas id="gameCanvas"></canvas>

  <!-- HUD -->
  <div id="uiOverlay">
    <div id="speedometer" class="panel">
      <div>
        <div class="speed-value" id="speedValue">0</div>
        <div class="speed-unit">KM/H</div>
      </div>
    </div>

    <div id="minimap" class="panel">
      <canvas id="minimapCanvas" width="200" height="200"></canvas>
    </div>

    <div id="scoreDisplay" class="panel">
      <div class="score-item"><span class="score-label">SCORE</span><span class="score-value" id="currentScore">0</span></div>
      <div class="score-item"><span class="score-label">COMBO</span><span class="score-value" id="comboMultiplier">x1</span></div>
      <div class="score-item"><span class="score-label">CASH</span><span class="score-value" id="cashEarned">$0</span></div>
    </div>

    <div id="controlPanel" class="panel">
      <button class="hud-btn" id="pauseBtn">PAUSE</button>
      <button class="hud-btn" id="resetBtn">RESET</button>
      <button class="hud-btn" id="boostBtn">BOOST</button>
    </div>
  </div>

  <!-- Damage overlay -->
  <div id="damageOverlay"></div>

  <!-- Main menu -->
  <div id="gameMenu">
    <div id="menuInner">
      <div id="menuContent">
        <div id="menuTitle">URBAN VELOCITY</div>
        <div class="menu-sub">STREET RACING REVOLUTION</div>

        <button class="menu-btn" id="startRaceBtn">START RACE</button>
        <button class="menu-btn" id="garageBtn">GARAGE</button>
        <button class="menu-btn" id="leaderboardBtn">LEADERBOARD</button>
        <button class="menu-btn" id="settingsBtn">SETTINGS</button>

        <p class="menu-tip">
          WASD / ARROWS TO STEER • SPACE = HANDBRAKE • BOOST BUTTON / X (PAD)
        </p>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loadingScreen">
    <div class="loader"></div>
    <div class="loader-text">INITIALIZING ENGINE...</div>
  </div>
</div>

<script>
class GameState{
  constructor(){
    this.score=0;this.combo=1;this.cash=0;this.speed=0;this.damage=0;
    this.maxSpeed=260;this.accel=90;
  }
  updateSpeed(v){
    this.speed=Math.max(0,Math.min(v,this.maxSpeed));
    document.getElementById('speedValue').textContent=Math.floor(this.speed);
  }
  addScore(v){
    this.score+=Math.floor(v*this.combo);
    document.getElementById('currentScore').textContent=this.score.toLocaleString();
  }
  setCombo(v){
    this.combo=Math.max(1,Math.min(v,10));
    document.getElementById('comboMultiplier').textContent='x'+this.combo.toFixed(1).replace(/\.0$/,'');
  }
  addCash(v){
    this.cash+=v;
    document.getElementById('cashEarned').textContent='$'+this.cash.toLocaleString();
  }
  reset(){
    this.score=0;this.combo=1;this.cash=0;this.speed=0;this.damage=0;
    this.updateSpeed(0);this.addScore(0);this.setCombo(1);
    document.getElementById('currentScore').textContent='0';
    document.getElementById('cashEarned').textContent='$0';
  }
}
const gameState=new GameState();

class InputManager{
  constructor(){
    this.keys={};this.gamepad=null;
    document.addEventListener('keydown',e=>this.keys[e.code]=true);
    document.addEventListener('keyup',e=>this.keys[e.code]=false);
    window.addEventListener('gamepadconnected',e=>this.gamepad=e.gamepad);
    window.addEventListener('gamepaddisconnected',()=>this.gamepad=null);
  }
  getState(){
    const s={accelerate:false,brake:false,steer:0,handbrake:false,boost:false};
    if(this.keys['KeyW']||this.keys['ArrowUp']) s.accelerate=true;
    if(this.keys['KeyS']||this.keys['ArrowDown']) s.brake=true;
    if(this.keys['KeyA']||this.keys['ArrowLeft']) s.steer-=1;
    if(this.keys['KeyD']||this.keys['ArrowRight']) s.steer+=1;
    if(this.keys['Space']) s.handbrake=true;
    if(this.gamepad){
      const gp=navigator.getGamepads()[this.gamepad.index];
      if(gp){
        s.accelerate|=gp.buttons[7].value>0.3;
        s.brake|=gp.buttons[6].value>0.3;
        s.steer=gp.axes[0];
        s.boost|=gp.buttons[0].pressed;
      }
    }
    return s;
  }
}

class Car{
  constructor(scene,loader){
    const tex=loader.load('resources/car-sports.jpg');
    tex.encoding=THREE.sRGBEncoding;
    const aspect=2.0, h=1.6, w=h*aspect;
    const geom=new THREE.PlaneGeometry(w,h);
    const mat=new THREE.MeshBasicMaterial({map:tex,transparent:true});
    this.mesh=new THREE.Mesh(geom,mat);
    this.mesh.position.set(0,1.2,0);
    this.mesh.rotation.y=Math.PI;
    scene.add(this.mesh);
    this.maxX=11;
  }
  update(input,dt){
    if(input.accelerate) gameState.updateSpeed(gameState.speed+gameState.accel*dt);
    else if(input.brake) gameState.updateSpeed(gameState.speed-gameState.accel*dt*1.2);
    else gameState.updateSpeed(gameState.speed*0.985);

    const dz=gameState.speed*dt*0.45;
    this.mesh.position.z-=dz;
    const L=480;
    if(this.mesh.position.z<-L) this.mesh.position.z=L;
    if(this.mesh.position.z> L) this.mesh.position.z=-L;

    this.mesh.position.x+=input.steer*dt*10;
    this.mesh.position.x=Math.max(-this.maxX,Math.min(this.mesh.position.x,this.maxX));
    this.mesh.rotation.z=-input.steer*0.35;

    if(Math.abs(this.mesh.position.x)===this.maxX) this.damageFlash();

    if(gameState.speed>5){
      gameState.addScore(gameState.speed*dt*0.8);
    }

    if(input.handbrake){
      gameState.updateSpeed(gameState.speed*0.97);
      gameState.setCombo(gameState.combo+0.03);
    }else{
      gameState.setCombo(gameState.combo-0.015);
    }
  }
  damageFlash(){
    const d=document.getElementById('damageOverlay');
    d.style.opacity='1';
    clearTimeout(this._dmgT);
    this._dmgT=setTimeout(()=>d.style.opacity='0',200);
  }
}

class RacingGame{
  constructor(){
    this.scene=new THREE.Scene();
    this.scene.fog=new THREE.FogExp2(0x020617,0.0032);

    this.camera=new THREE.PerspectiveCamera(
      65,
      window.innerWidth/window.innerHeight,
      0.1,
      1000
    );
    this.camera.position.set(0,7,14);

    this.renderer=new THREE.WebGLRenderer({
      canvas:document.getElementById('gameCanvas'),
      antialias:true
    });
    this.renderer.setSize(window.innerWidth,window.innerHeight);
    this.renderer.setPixelRatio(window.devicePixelRatio||1);

    this.loader=new THREE.TextureLoader();
    this.input=new InputManager();
    this.clock=new THREE.Clock();
    this.running=false;
    this.paused=false;

    this.setupLights();
    this.setupEnvironment();
    this.car=new Car(this.scene,this.loader);

    window.addEventListener('resize',()=>this.onResize());
    this.setupUI();
    this.finishLoading();
  }
  setupLights(){
    const amb=new THREE.AmbientLight(0x1f2933,0.9);
    this.scene.add(amb);
    const dir=new THREE.DirectionalLight(0xffffff,0.8);
    dir.position.set(30,80,20);
    this.scene.add(dir);
    const n1=new THREE.PointLight(0x00d4ff,1.6,120);
    n1.position.set(-9,4,-20);this.scene.add(n1);
    const n2=new THREE.PointLight(0xff1f71,1.6,120);
    n2.position.set(9,4,-40);this.scene.add(n2);
  }
  setupEnvironment(){
    // ground
    const gGeom=new THREE.PlaneGeometry(80,1200);
    const gMat=new THREE.MeshPhongMaterial({color:0x05070b,shininess:5});
    const ground=new THREE.Mesh(gGeom,gMat);
    ground.rotation.x=-Math.PI/2;
    this.scene.add(ground);

    // road
    const rGeom=new THREE.PlaneGeometry(26,1200);
    const rMat=new THREE.MeshStandardMaterial({color:0x111827,roughness:.85,metalness:.1});
    const road=new THREE.Mesh(rGeom,rMat);
    road.rotation.x=-Math.PI/2;
    road.position.y=0.01;
    this.scene.add(road);

    // center line
    const dashGeom=new THREE.BoxGeometry(0.5,0.02,6);
    const dashMat=new THREE.MeshBasicMaterial({color:0xf9fafb});
    for(let z=-580;z<580;z+=16){
      const dash=new THREE.Mesh(dashGeom,dashMat);
      dash.position.set(0,0.04,z);
      this.scene.add(dash);
    }

    // side glow
    const glowGeom=new THREE.PlaneGeometry(1,1200);
    const lMat=new THREE.MeshBasicMaterial({color:0x00d4ff,transparent:true,opacity:.5,side:THREE.DoubleSide});
    const rMat2=new THREE.MeshBasicMaterial({color:0xff1f71,transparent:true,opacity:.5,side:THREE.DoubleSide});
    const lg=new THREE.Mesh(glowGeom,lMat);lg.rotation.x=-Math.PI/2;lg.position.set(-12.5,0.02,0);
    const rg=new THREE.Mesh(glowGeom,rMat2);rg.rotation.x=-Math.PI/2;rg.position.set(12.5,0.02,0);
    this.scene.add(lg,rg);

    // background wall from resources/city-background.jpg
    const bgTex=this.loader.load('resources/city-background.jpg');
    bgTex.encoding=THREE.sRGBEncoding;
    const bgGeom=new THREE.PlaneGeometry(120,40);
    const bgMat=new THREE.MeshBasicMaterial({map:bgTex});
    const bg=new THREE.Mesh(bgGeom,bgMat);
    bg.position.set(0,16,-90);
    this.scene.add(bg);
  }
  setupUI(){
    document.getElementById('startRaceBtn').onclick=()=>this.start();
    document.getElementById('garageBtn').onclick=()=>alert('Garage not implemented yet.');
    document.getElementById('leaderboardBtn').onclick=()=>alert('Leaderboard not implemented yet.');
    document.getElementById('settingsBtn').onclick=()=>alert('Settings not implemented yet.');
    document.getElementById('pauseBtn').onclick=()=>this.togglePause();
    document.getElementById('resetBtn').onclick=()=>this.reset();
    document.getElementById('boostBtn').onclick=()=>this.boost();
  }
  finishLoading(){
    setTimeout(()=>{
      document.getElementById('loadingScreen').style.display='none';
      // menu already visible
    },1200);
  }
  start(){
    if(this.running) return;
    this.running=true;
    document.getElementById('gameMenu').classList.add('hidden');
    this.clock.getDelta();
    this.loop();
  }
  togglePause(){
    if(!this.running) return;
    this.paused=!this.paused;
    if(!this.paused){this.clock.getDelta();this.loop();}
  }
  reset(){
    gameState.reset();
    this.car.mesh.position.set(0,1.2,0);
  }
  boost(){
    if(gameState.speed<40) return;
    gameState.updateSpeed(gameState.speed*1.4);
    gameState.addScore(300);
  }
  loop(){
    if(!this.running||this.paused) return;
    requestAnimationFrame(()=>this.loop());
    const dt=this.clock.getDelta();
    const input=this.input.getState();
    this.car.update(input,dt);
    this.updateCamera();
    this.updateMinimap();
    this.renderer.render(this.scene,this.camera);
  }
  updateCamera(){
    const target=new THREE.Vector3(
      this.car.mesh.position.x,
      this.car.mesh.position.y+6,
      this.car.mesh.position.z+14
    );
    this.camera.position.lerp(target,0.12);
    const look=this.car.mesh.position.clone();look.y+=1.2;
    this.camera.lookAt(look);
  }
  updateMinimap(){
    const c=document.getElementById('minimapCanvas');
    const ctx=c.getContext('2d');
    const w=c.width,h=c.height;
    ctx.fillStyle='#020617';ctx.fillRect(0,0,w,h);
    ctx.fillStyle='#111827';
    ctx.fillRect(w/2-24,10,48,h-20);
    ctx.strokeStyle='#4b5563';ctx.setLineDash([4,4]);
    ctx.beginPath();ctx.moveTo(w/2,12);ctx.lineTo(w/2,h-12);ctx.stroke();ctx.setLineDash([]);

    const L=480, X=11;
    const cx=this.car.mesh.position.x;
    const cz=this.car.mesh.position.z;
    const x=w/2 + (cx/X)*22;
    const zn=(cz+L)/(2*L);
    const y=h-12 - zn*(h-24);
    ctx.fillStyle='#00f2ff';
    ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2);ctx.fill();
  }
  onResize(){
    this.camera.aspect=window.innerWidth/window.innerHeight;
    this.camera.updateProjectionMatrix();
    this.renderer.setSize(window.innerWidth,window.innerHeight);
  }
}

window.addEventListener('DOMContentLoaded',()=>{ new RacingGame(); });
</script>
</body>
</html>
